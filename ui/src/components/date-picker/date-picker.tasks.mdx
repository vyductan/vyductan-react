# DatePicker Component Tasks & Implementation Notes

## âœ… Completed Tasks

### Migration from Date to Dayjs
- [x] **Type Migration**: Updated all type annotations from `Date` to `Dayjs`
- [x] **Import Cleanup**: Removed `date-fns` imports and replaced with `dayjs`
- [x] **Generic Type Safety**: Fixed `DateValueType` generic type constraints
- [x] **State Management**: Updated all state variables to use Dayjs objects

### Props
- [x] **value**: Controlled value (Dayjs)
- [x] **defaultValue**: Uncontrolled initial value (Dayjs)
- [x] **onChange**: Change callback (function)
- [x] **format**: Date format string
- [x] **showTime**: Show time picker
- [x] **disabledDate**: Disable specific dates
- [x] **minDate**: Minimum selectable date (Dayjs)
- [x] **maxDate**: Maximum selectable date (Dayjs)
- [x] **placeholder**: Input placeholder
- [x] **className**: CSS classes
- [x] **styles**: CSS styles
- [x] **suffix**: Custom suffix content

### Input Handling Fixes
- [x] **Real-time Sync**: Input typing updates calendar month and selected date
- [x] **Calendar Highlight**: Typed dates are visually highlighted in calendar
- [x] **Validation**: Proper date parsing and validation with dayjs
- [x] **State Synchronization**: Input and calendar stay in perfect sync

### Antd DatePicker Behavior Parity
- [x] **Enter Key**: Confirms valid date, triggers onChange, closes popup
- [x] **Escape Key**: Only triggers onChange if input is valid, otherwise just closes
- [x] **Blur/Click Outside**: Validates input, triggers onChange if valid, reverts if invalid
- [x] **Calendar Selection**: Always triggers onChange with selected date
- [x] **Input Typing**: Updates calendar display without triggering onChange
- [x] **Calendar Click Fix**: Prevent blur from closing calendar when clicking calendar days

### Year Selection & Preview
- [x] **Hover Preview (year/day)**: Input shows dimmed preview while hovering years/days in the popover
- [x] **Sticky Preview after Year Select**: After picking a year in overlay, keep a sticky preview until commit/close
- [x] **Commit-on-Close (overlay)**: New prop `commitYearOnClose` commits the selected year when popover closes
- [x] **Caption Dropdown Support**: When `captionLayout="dropdown"`, changing year sets pending commit so closing will commit when enabled
- [x] **Pure Year Picker**: With `picker="year"`, selecting year commits immediately and closes
- [x] **Keyboard**: Year cells are focusable with Enter/Space select

### Type Safety & Error Handling
- [x] **TypeScript Compilation**: All code compiles without errors
- [x] **Generic Type Constraints**: Proper handling of `DateValueType` generic
- [x] **Null Safety**: Proper handling of undefined/null values
- [x] **Error Boundaries**: Graceful handling of invalid date inputs

### State Management
- [x] **Temporary Selection**: `typedDate` state for calendar highlighting
- [x] **Month Synchronization**: Automatic calendar month navigation
- [x] **Value Reversion**: Proper rollback to previous value on invalid input
- [x] **State Cleanup**: Proper cleanup when clearing values
- [x] **Value Synchronization**: useEffect for syncing input value when external value changes

## ðŸŽ¯ Key Implementation Details

### Behavior Logic
```typescript
// Escape key: Only trigger onChange if input is valid
if (inputValue.trim()) {
  const parsed = dayjs(inputValue, format);
  if (parsed.isValid()) {
    setValue(parsed as DateValueType);
    setInputValue(parsed.format(format));
  }
}

// Blur: Validate and trigger onChange, or revert
if (inputValue.trim()) {
  const parsed = dayjs(inputValue, format);
  if (parsed.isValid()) {
    setValue(parsed as DateValueType); // Valid â†’ onChange
  } else {
    // Invalid â†’ revert to previous value
    setInputValue(value ? (value as Dayjs).format(format) : "");
  }
}
```

### State Variables
- `value`: The actual selected date value
- `inputValue`: The display value in the input field
- `typedDate`: Temporary date for calendar highlighting
- `month`: Calendar month navigation

### Event Handlers
- `onChange`: Updates calendar display without triggering onChange
- `onKeyUp`: Handles Enter/Escape with validation
- `onBlur`: Handles blur with validation and reversion
- `onSelect`: Calendar selection always triggers onChange
- `useEffect`: Synchronizes input value when external value changes

### Commit-on-Close Flow (overlay)
1. User selects a year (or changes via caption year dropdown) â†’ set sticky preview and mark pending commit
2. If a day is selected â†’ commit immediately and clear pending
3. If popover closes and `commitYearOnClose` is true and pending is set â†’ commit sticky preview
4. Clear hover/sticky preview and pending flag after close

## ðŸ”„ Migration Notes

### Before (Date objects)
```typescript
const [value, setValue] = useState<Date | null>(null);
const handleChange = (date: Date | null) => setValue(date);
```

### After (Dayjs objects)
```typescript
const [value, setValue] = useState<DateValueType | null>(null);
const handleChange = (date: DateValueType | null) => setValue(date);
```

## ðŸ§ª Testing Checklist
- [x] TypeScript compilation passes
- [x] All date formats work correctly
- [x] Keyboard navigation works
- [x] Calendar synchronization works
- [x] Validation logic works
- [x] Error handling works
- [x] Edge cases handled
- [x] Year hover/selection updates preview text with dimmed style
- [x] Commit-on-close commits sticky preview when enabled
- [x] Caption year dropdown marks pending and commits on close
- [x] Day selection clears pending and commits immediately

## ðŸ”œ TODO / Future Enhancements
- [ ] Configurable commit strategy when committing a year:
  - `preserve-day` (current overlay behavior)
  - `start-of-month`
  - `start-of-year`
- [ ] Consider adding an opt-in ref-backed pending flag if more race conditions appear with rapid close flows
- [ ] Expand keyboard navigation for year grid (arrow navigation)

## ðŸ“‹ Usage Examples

### Basic Usage
```typescript
<DatePicker
  value={selectedDate}
  onChange={(date) => setSelectedDate(date)}
  format="YYYY-MM-DD"
/>
```

### With Validation
```typescript
<DatePicker
  value={selectedDate}
  onChange={(date) => setSelectedDate(date)}
  disabledDate={(date) => date.isBefore(dayjs())}
/>
```
